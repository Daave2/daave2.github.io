<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!--‚ÄâPWA & meta‚Äâ-->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="theme-color" content="#006400" />
  <title>Cleveleys Morrisons ‚Äì Management Dashboard</title>
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png" />
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="description"
    content="Cleveleys Morrisons Management Dashboard for tasks, notes, scheduling and operational guides." />

  <!--‚ÄâFonts & icons‚Äâ-->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <!-- Using updated Font Awesome version -->
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" as="style"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!--‚ÄâStyles ‚Äì mobile-first‚Äâ-->
  <script src="components/header.js" defer></script>
  <script src="components/nav.js" defer></script>
  <script src="components/back-to-top.js" defer></script>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <script>
    (function () {
      const isDark = localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
      if (isDark) {
        document.body.classList.add('dark-mode');
      }
    })();
  </script>
  <!----- header & theme toggle ----->
  <site-header></site-header>

  <!----- nav (bottom bar on phones) ----->
  <site-nav></site-nav>

  <!----- main content ----->
  <main class="container" id="main-content">

    <!-- Search Section -->
    <section id="site-search-section" aria-labelledby="search-heading">
      <h2 id="search-heading" class="visually-hidden">Site Search</h2> <!-- Hidden heading for accessibility -->
      <div class="search-container">
        <label for="site-search" class="visually-hidden">Search this site:</label>
        <input type="search" id="site-search" placeholder="Search pages & sections...">
        <div id="search-results" class="search-results-dropdown" aria-live="polite"></div>
      </div>
    </section>
    <!-- End Search Section -->

    <!-- welcome -->
    <!-- Hero Section -->
    <section id="hero-section">
      <div class="hero-content">
        <h1 id="hero-greeting">Welcome</h1>
        <p>Quick access to essential tools, reports and operational guides for Cleveleys Morrisons Management.</p>
        <p id="hero-date" class="hero-date"></p>
        <p id="hero-change-name" style="display: none; font-size: 0.85rem; margin-top: 0.5rem;">
          <a href="#" id="change-name-link" style="color: var(--text-muted); text-decoration: underline;">Not you?
            Change name</a>
        </p>
      </div>
      <div class="hero-clock">
        <div id="hero-weather" class="hero-weather"></div>
        <span id="clock-time">00:00</span>
      </div>
    </section>

    <!-- Daily Checklist Widget -->
    <section id="checklist-widget" class="checklist-widget">
      <div class="checklist-widget-header">
        <h2><i class="fas fa-clipboard-check"></i> Daily Checklist</h2>
        <div class="checklist-widget-controls">
          <span id="widget-progress" class="widget-progress">0/0</span>
          <button id="widget-history" class="widget-sync-btn" title="History">
            <i class="fas fa-history"></i>
          </button>
          <button id="widget-manage" class="widget-sync-btn" title="Manage Tasks">
            <i class="fas fa-cog"></i>
          </button>
          <button id="widget-reset-token" class="widget-sync-btn" title="Reset Token/Login">
            <i class="fas fa-key"></i>
          </button>
          <button id="widget-sync" class="widget-sync-btn" title="Sync">
            <i class="fas fa-sync-alt"></i>
          </button>
        </div>
      </div>


      <div id="widget-loading" class="widget-loading">
        <i class="fas fa-spinner fa-spin"></i> Loading...
      </div>
      <div id="widget-error" class="widget-error" style="display: none;">
        Checklist unavailable
      </div>
      <div id="widget-content" class="widget-content" style="display: none;"></div>
    </section>

    <!-- dashboard -->
    <section id="dashboard">
      <h2>Quick Links</h2>
      <div class="dashboard-grid">
        <a href="https://storemobile.apps.mymorri.com/#/choose-option/218" class="tile" data-open="frame"
          title="Store Mobile App"><i class="fas fa-mobile-alt"></i><span>Store App</span></a>
        <a href="https://app.218.team" class="tile" data-open="external" title="Stock Info App (opens new tab)"><i
            class="fas fa-box"></i><span>Stock Info (SMU)</span></a>
        <a href="https://www.dymension.co.uk/#/account/login" class="tile" data-open="frame" title="Staff Checks"><i
            class="fas fa-user-check"></i><span>Staff Checks</span></a>
        <a href="https://priceintegrity.apps.mymorri.com/#/checks" class="tile" data-open="external"
          title="Price Integrity Logbook (opens new tab)"><i class="fas fa-book"></i><span>Logbook</span></a>
        <a href="https://morrisonsprd.cloud.looker.com/dashboards/retail::store_inbound_report" class="tile"
          data-open="external" title="Looker Delivery Volume Report (opens new tab)"><i
            class="fas fa-chart-line"></i><span>Delivery Vol</span></a>
        <a href="https://script.google.com/a/macros/morrisonsplc.co.uk/s/AKfycbwO5CmuEkGFtPLXaZ_B2gMLrWhkLgONDlnsHt3HhOWzHen4yCbVOHA7O8op79zq2NYfCQ/exec"
          class="tile" data-open="external" title="Retail Wheel Dashboard (opens new tab)"><i
            class="fas fa-tachometer-alt"></i><span>Retail Wheel</span></a>
        <a href="https://script.google.com/a/macros/morrisonsplc.co.uk/s/AKfycbwO5CmuEkGFtPLXaZ_B2gMLrWhkLgONDlnsHt3HhOWzHen4yCbVOHA7O8op79zq2NYfCQ/exec"
          class="tile" data-open="external" title="NPS Dashboard (opens new tab)"><i
            class="fas fa-smile"></i><span>NPS</span></a>
        <a href="https://lookerstudio.google.com/u/1/reporting/b28a8a2b-e768-483f-bb21-c0452cf8592d/page/jhKME"
          class="tile" data-open="external" title="Looker Studio Transfers Report (opens new tab)"><i
            class="fas fa-exchange-alt"></i><span>Transfers</span></a>
        <a href="https://lookerstudio.google.com/embed/u/1/reporting/b69cfd73-8c0a-453d-9c10-6561fa953f7c/page/p_swllr1wxqd"
          class="tile" data-open="external" title="Looker Studio Complaints Dashboard (opens new tab)"><i
            class="fas fa-comments"></i><span>Complaints Dash</span></a>
        <a href="https://storemapper-ai-584939250419.us-west1.run.app" class="tile" data-open="external"
          title="Promo Map (opens new tab)"><i class="fas fa-map-marked-alt"></i><span>Promo Map</span></a>
        <a href="https://live.microlise.com/MORRISONS/TMCWebPortal/authentication/login.aspx?ReturnUrl=%2fMORRISONS%2fTMCWebPortal%2fSite%2fVisits%2f218%3fsiteIdEncoded%3dFalse&amp;siteIdEncoded=False"
          class="tile" data-open="external" title="Microlise Delivery Tracker (opens new tab)"><i
            class="fas fa-truck"></i><span>Delivery Tracker</span></a>
        <a href="https://script.google.com/a/macros/morrisonsplc.co.uk/s/AKfycbwcruXBXnOk0d1wlfZJHn4sy4IYpuj1GMtzSldMHAj2VWxNCKjEuGiEqCCpTfkWXUcp/exec"
          class="tile" data-open="external" title="Google Script - Reminders (opens new tab)"><i
            class="fas fa-calendar-check"></i><span>Reminders</span></a>
        <a href="operations.html" class="tile" data-open="self" title="Operational Guides"><i
            class="fas fa-cogs"></i><span>Operations</span></a>
        <a href="shrink.html" class="tile" data-open="self" title="Shrink Management Guides"><i
            class="fas fa-compress-arrows-alt"></i><span>Shrink</span></a>
        <a href="https://marketstreet.retail.apps.mymorri.com/" class="tile" data-open="external"
          title="Production Plans (Opens new tab)"><i class="fas fa-clipboard-list"></i><span>Production</span></a>
      </div>
    </section>

    <!-- Content Frame Container -->
    <div id="frame-container">
      <button id="close-frame" title="Close Frame"><i class="fas fa-times"></i> Close</button>
      <div class="iframe-loading-container">
        <div class="iframe-loading"></div>
        <iframe id="content-frame" title="Embedded Content Frame" src="about:blank"></iframe>
      </div>
      <div id="fallback-message" role="alert">
        <p>Unable to load this page within the frame.<br>
          <a id="fallback-link" href="" target="_blank" rel="noopener noreferrer">Click here</a> to open it in a new
          tab.
        </p>
      </div>
    </div>

    <!-- Who Is In Today Section -->
    <section id="who-is-in">
      <h2>Who Is In Today?</h2>
      <div id="whos-in-container" class="whos-in-container">
        <!-- Populated by rota.js -->
      </div>
    </section>

    <!-- Reminders App Section -->
    <section id="reminders-app">
      <h2>Reminders</h2>
      <p>Access the reminders application.</p>
      <a href="https://script.google.com/a/macros/morrisonsplc.co.uk/s/AKfycbwcruXBXnOk0d1wlfZJHn4sy4IYpuj1GMtzSldMHAj2VWxNCKjEuGiEqCCpTfkWXUcp/exec"
        target="_blank" rel="noopener noreferrer" class="button-link"><i class="fas fa-external-link-alt fa-xs"></i>
        Open Reminders App</a>
    </section>

    <!-- Management Rota Section -->
    <section id="management-rota">
      <h2>Management Rota</h2>
      <div class="iframe-loading-container">
        <div class="iframe-loading"></div>
        <div class="iframe-wrap">
          <iframe
            data-src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTYlntl23_036PdM7a3KIWjPjvq9AEXJdT6V_oCb9KHPfmu3tLBhcEDVwyVnY0c0Ye9-It8ZbS_PnAz/pubhtml?widget=true&headers=false"
            title="Management Rota Spreadsheet" loading="lazy"></iframe>
        </div>
      </div>
      <a href="https://docs.google.com/spreadsheets/d/1TYlntl23_036PdM7a3KIWjPjvq9AEXJdT6V_oCb9KHPfmu3tLBhcEDVwyVnY0c0Ye9-It8ZbS_PnAz/edit#gid=0"
        class="button-link" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt fa-xs"></i>
        View Full Rota</a>
    </section>

    <!-- Retail Wheel Section -->
    <section id="wheel">
      <h2>Retail Wheel</h2>
      <p>Comprehensive overview of store performance metrics.</p>
      <a href="https://script.google.com/a/macros/morrisonsplc.co.uk/s/AKfycbwO5CmuEkGFtPLXaZ_B2gMLrWhkLgONDlnsHt3HhOWzHen4yCbVOHA7O8op79zq2NYfCQ/exec"
        class="button-link" target="_blank" rel="noopener noreferrer"><i class="fas fa-external-link-alt fa-xs"></i>
        Open Retail Wheel</a>
    </section>

    <!-- ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî WHITEBOARD ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->
    <section id="notes">
      <h2>Notes Whiteboard</h2>
      <p>Sketch, annotate or leave reminders ‚Äì they stay in your browser storage.</p>

      <div class="whiteboard-container" id="whiteboard-container">
        <!-- Unified Sticky Toolbar -->
        <div class="whiteboard-toolbar" role="toolbar" aria-label="Whiteboard tools">
          <!-- Drawing Tools -->
          <div class="toolbar-group">
            <button class="tool-button active" data-tool="pen" aria-label="Pen (P)" title="Pen (P)"><i
                class="fas fa-pencil-alt"></i></button>
            <button class="tool-button" data-tool="text" aria-label="Text (T)" title="Text (T)"><i
                class="fas fa-font"></i></button>
            <button class="tool-button" data-tool="eraser" aria-label="Eraser (E)" title="Eraser (E)"><i
                class="fas fa-eraser"></i></button>
          </div>

          <!-- Shape Tools -->
          <div class="toolbar-group">
            <button class="tool-button" data-tool="line" aria-label="Line (L)" title="Line (L)"><i
                class="fas fa-minus"></i></button>
            <button class="tool-button" data-tool="rectangle" aria-label="Rectangle (R)" title="Rectangle (R)"><i
                class="far fa-square"></i></button>
            <button class="tool-button" data-tool="circle" aria-label="Circle (C)" title="Circle (C)"><i
                class="far fa-circle"></i></button>
            <button class="tool-button" data-tool="arrow" aria-label="Arrow (A)" title="Arrow (A)"><i
                class="fas fa-long-arrow-alt-right"></i></button>
          </div>

          <!-- Color Palette -->
          <div class="toolbar-group color-palette">
            <input id="colorPicker" class="color-picker" type="color" value="#000000" title="Custom Color">
            <button class="color-swatch" data-color="#000000" style="background:#000000" title="Black"></button>
            <button class="color-swatch" data-color="#ffffff" style="background:#ffffff" title="White"></button>
            <button class="color-swatch" data-color="#ff0000" style="background:#ff0000" title="Red"></button>
            <button class="color-swatch" data-color="#00853E" style="background:#00853E" title="Green"></button>
            <button class="color-swatch" data-color="#0066cc" style="background:#0066cc" title="Blue"></button>
            <button class="color-swatch" data-color="#FFD700" style="background:#FFD700" title="Yellow"></button>
          </div>

          <!-- Settings -->
          <div class="toolbar-group">
            <select id="brushSize" class="brush-size" title="Brush Size">
              <option>2</option>
              <option selected>4</option>
              <option>8</option>
              <option>12</option>
              <option>20</option>
            </select>
            <select id="fontSize" class="font-size" title="Font Size">
              <option>14</option>
              <option selected>18</option>
              <option>24</option>
              <option>32</option>
            </select>
            <input id="opacity" class="opacity-slider" type="range" min="10" max="100" value="100" title="Opacity">
          </div>

          <!-- Canvas Controls -->
          <div class="toolbar-group">
            <button class="grid-button" aria-label="Toggle Grid (G)" title="Toggle Grid (G)"><i
                class="fas fa-th"></i></button>
            <button class="zoom-in-button" aria-label="Zoom In (+)" title="Zoom In (+)"><i
                class="fas fa-search-plus"></i></button>
            <button class="zoom-out-button" aria-label="Zoom Out (-)" title="Zoom Out (-)"><i
                class="fas fa-search-minus"></i></button>
            <button class="zoom-reset-button" aria-label="Reset Zoom (0)" title="Reset Zoom (0)"><i
                class="fas fa-compress-arrows-alt"></i></button>
          </div>

          <!-- Actions -->
          <div class="toolbar-group">
            <button class="undo-button" aria-label="Undo (‚åò/Ctrl+Z)" title="Undo (‚åò/Ctrl+Z)"><i
                class="fas fa-undo"></i></button>
            <button class="redo-button" aria-label="Redo (‚åò/Ctrl+Y)" title="Redo (‚åò/Ctrl+Y)"><i
                class="fas fa-redo"></i></button>
            <button class="clear-button" aria-label="Clear (Del)" title="Clear (Del)"><i
                class="fas fa-trash"></i></button>
          </div>

          <!-- File Actions -->
          <div class="toolbar-group">
            <button class="save-button" aria-label="Save (‚åò/Ctrl+S)" title="Save (‚åò/Ctrl+S)"><i
                class="fas fa-save"></i></button>
            <button class="load-button" aria-label="Load" title="Load"><i class="fas fa-upload"></i></button>
            <button class="fill-button" aria-label="Fill Background" title="Fill Background"><i
                class="fas fa-fill-drip"></i></button>
            <button class="export-png-button" aria-label="Download PNG" title="Download PNG"><i
                class="fas fa-download"></i></button>
            <button class="fullscreen-button" aria-label="Fullscreen (F)" title="Fullscreen (F)"><i
                class="fas fa-expand"></i></button>
          </div>
        </div>

        <!-- Canvas -->
        <div class="whiteboard-canvas-wrap">
          <canvas id="whiteboard" aria-label="Interactive whiteboard"></canvas>
          <div id="eraser-preview"></div>
        </div>
      </div>
    </section>
    <!-- ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî -->
  </main>

  <!----- footer ----->
  <footer>
    <p>¬© <span id="footer-year"></span> Cleveleys Morrisons. All rights reserved.</p>
  </footer>

  <!----- back to top button ----->
  <back-to-top></back-to-top>

  <!----- notification placeholder ----->
  <div class="notification" id="notification" role="alert" aria-live="assertive"></div>

  <!-- Management Modal -->
  <div id="manage-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Manage Tasks</h3>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="manage-list"></div>
        <div class="add-task-form">
          <h4>Add New Task</h4>
          <select id="new-task-category">
            <option value="morning">Morning</option>
            <option value="midday">Midday</option>
            <option value="afternoon">Fit for 5</option>
            <option value="weekly">Weekly</option>
          </select>
          <input type="text" id="new-task-label" placeholder="Task name">
          <input type="text" id="new-task-time" placeholder="Time (opt)">

          <div style="margin-bottom: 0.5rem; display: flex; gap: 0.5rem;">
            <select id="new-task-freq" style="flex: 1;">
              <option value="daily">Every Day</option>
              <option value="weekly">Weekly</option>
              <option value="once">One-time</option>
            </select>
            <div id="freq-date-container" style="display: none; flex: 1;">
              <input type="date" id="freq-date" style="width: 100%; padding: 0.25rem;">
            </div>
          </div>
          <small id="freq-hint" style="display: block; color: #666; margin-bottom: 0.5rem; font-size: 0.8rem;"></small>

          <button id="add-task-btn">Add Task</button>
        </div>
      </div>
    </div>
  </div>

  <!-- History Modal -->
  <div id="history-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Checklist History</h3>
        <button class="close-history">&times;</button>
      </div>
      <div class="modal-body">
        <div id="history-list"></div>
      </div>
    </div>
  </div>

  <!----- scripts ----->
  <script src="script.js" type="module"></script>

  <!-- Checklist Widget Script -->
  <script type="module">
    import { checklistManager, DEFAULT_ITEMS, TEAM_MEMBERS, setToken, getUsername, setUsername } from './js/modules/checklist.js';

    const widgetLoading = document.getElementById('widget-loading');
    const widgetError = document.getElementById('widget-error');
    const widgetContent = document.getElementById('widget-content');
    const widgetProgress = document.getElementById('widget-progress');
    const widgetSync = document.getElementById('widget-sync');
    const heroGreeting = document.getElementById('hero-greeting');
    const heroChangeName = document.getElementById('hero-change-name');
    const changeNameLink = document.getElementById('change-name-link');

    // Update hero greeting based on time and name
    function updateHeroGreeting() {
      const name = getUsername();
      const hour = new Date().getHours();
      let greeting = 'Good evening';
      if (hour < 12) greeting = 'Good morning';
      else if (hour < 17) greeting = 'Good afternoon';

      if (name && name !== 'Team') {
        heroGreeting.textContent = `${greeting}, ${name}`;
        changeNameLink.textContent = `Not ${name}?`;
      } else {
        heroGreeting.textContent = 'Welcome';
        changeNameLink.textContent = 'Set Name';
      }
      heroChangeName.style.display = 'block';
    }

    // Handle name change
    changeNameLink?.addEventListener('click', (e) => {
      e.preventDefault();
      const newName = prompt('Enter your name:');
      if (newName?.trim()) {
        setUsername(newName.trim());
        updateHeroGreeting();
      }
    });

    function buildAssignOptions(currentAssignee) {
      const isCustom = currentAssignee && !TEAM_MEMBERS.includes(currentAssignee);
      let options = '<option value="">Assign...</option>';
      TEAM_MEMBERS.forEach(member => {
        const selected = member === currentAssignee ? 'selected' : '';
        options += `<option value="${member}" ${selected}>${member}</option>`;
      });
      options += `<option value="__other__" ${isCustom ? 'selected' : ''}>Other...</option>`;
      return options;
    }

    function renderWidget() {
      widgetContent.innerHTML = '';
      let total = 0, completed = 0;

      // Use dynamic items from manager (includes any custom tasks)
      const items = checklistManager.getItems();

      Object.entries(items).forEach(([categoryId, category]) => {
        const categoryEl = document.createElement('div');
        categoryEl.className = 'widget-category';

        const headerEl = document.createElement('div');
        headerEl.className = 'widget-category-header';
        headerEl.innerHTML = `<i class="fas fa-chevron-down"></i> ${category.title}`;
        headerEl.addEventListener('click', () => {
          categoryEl.classList.toggle('collapsed');
          headerEl.querySelector('i').className = categoryEl.classList.contains('collapsed')
            ? 'fas fa-chevron-right' : 'fas fa-chevron-down';
        });
        categoryEl.appendChild(headerEl);

        const itemsEl = document.createElement('div');
        itemsEl.className = 'widget-items';

        category.items.forEach(item => {
          total++;
          const state = checklistManager.getItemState(item.id);
          if (state.checked) completed++;

          const itemEl = document.createElement('div');
          itemEl.className = `widget-item${state.checked ? ' checked' : ''}`;

          itemEl.innerHTML = `
            <div class="widget-checkbox" data-id="${item.id}">
              ${state.checked ? '<i class="fas fa-check"></i>' : ''}
            </div>
            <div class="widget-item-content">
              <span class="widget-item-label">
                ${item.time ? `<strong>${item.time}</strong> ` : ''}${item.label}
                ${state.assignedTo ? `<span class="widget-badge">${state.assignedTo}</span>` : ''}
              </span>
              ${state.checked ? `<span class="widget-meta">‚úì ${state.checkedBy} ${state.checkedAt}</span>` : ''}
            </div>
            <select class="widget-assign" data-id="${item.id}">
              ${buildAssignOptions(state.assignedTo)}
            </select>
          `;

          // Checkbox click
          itemEl.querySelector('.widget-checkbox').addEventListener('click', async (e) => {
            e.stopPropagation();
            try {
              await checklistManager.toggleItem(item.id);
            } catch (err) {
              console.error(err);
            }
          });

          // Assignment change
          itemEl.querySelector('.widget-assign').addEventListener('change', async (e) => {
            e.stopPropagation();
            const val = e.target.value;
            if (val === '__other__') {
              const name = prompt('Enter name:');
              if (name?.trim()) {
                await checklistManager.assignItem(item.id, name.trim());
              } else {
                renderWidget();
              }
            } else {
              await checklistManager.assignItem(item.id, val || null);
            }
          });

          itemsEl.appendChild(itemEl);
        });

        categoryEl.appendChild(itemsEl);
        widgetContent.appendChild(categoryEl);
      });

      widgetProgress.textContent = `${completed}/${total}`;
    }

    // --- Management UI Logic ---
    const manageModal = document.getElementById('manage-modal');
    const manageList = document.getElementById('manage-list');
    const manageBtn = document.getElementById('widget-manage');

    // Frequency UI Logic
    const freqSelect = document.getElementById('new-task-freq');
    const freqDateContainer = document.getElementById('freq-date-container');
    const freqDate = document.getElementById('freq-date');
    const freqHint = document.getElementById('freq-hint');

    // Set min date to today
    const todayStr = new Date().toISOString().split('T')[0];
    freqDate.min = todayStr;
    freqDate.value = todayStr;

    function updateFreqUI() {
      const val = freqSelect.value;
      const dateVal = freqDate.value;

      freqHint.textContent = '';
      freqDateContainer.style.display = 'none';

      if (val === 'weekly') {
        freqDateContainer.style.display = 'block';
        if (dateVal) {
          const dayName = new Date(dateVal).toLocaleDateString('en-US', { weekday: 'long' });
          freqHint.textContent = `Will repeat every ${dayName}`;
        } else {
          freqHint.textContent = 'Pick a date to set the day of week';
        }
      } else if (val === 'once') {
        freqDateContainer.style.display = 'block';
        freqHint.textContent = dateVal ? `Will appear on ${dateVal} only` : 'Pick a due date';
      }
    }

    freqSelect.addEventListener('change', updateFreqUI);
    freqDate.addEventListener('input', updateFreqUI);

    // Open management modal
    manageBtn.addEventListener('click', () => {
      renderManageList();
      manageModal.style.display = 'flex';
      // Reset freq options
      freqSelect.value = 'daily';
      freqDate.value = todayStr;
      updateFreqUI();
    });

    // Close modal
    document.querySelector('.close-modal').addEventListener('click', () => {
      manageModal.style.display = 'none';
    });

    manageModal.addEventListener('click', (e) => {
      if (e.target === manageModal) manageModal.style.display = 'none';
    });

    // Render management list (Definitions)
    function renderManageList() {
      manageList.innerHTML = '';
      const definitions = checklistManager.getAllDefinitions();

      Object.entries(definitions).forEach(([categoryId, category]) => {
        // Handle both Object {title, items} and Array formats
        const tasks = Array.isArray(category) ? category : (category.items || []);
        const catTitle = category.title || DEFAULT_ITEMS[categoryId]?.title || categoryId;
        const catHeader = document.createElement('div');
        catHeader.className = 'manage-category-header';
        catHeader.textContent = catTitle;
        manageList.appendChild(catHeader);

        tasks.forEach(task => {
          let scheduleInfo = '';
          const s = task.schedule;
          if (s.type === 'weekly') {
            const days = s.days.map(d => ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][d]).join(', ');
            scheduleInfo = `<small style="color: #666; display: block;">Weekly: ${days}</small>`;
          } else if (s.type === 'once') {
            scheduleInfo = `<small style="color: #666; display: block;">Once: ${s.date}</small>`;
          }

          const itemEl = document.createElement('div');
          itemEl.className = 'manage-item';
          itemEl.innerHTML = `
            <div class="manage-item-info">
              ${task.time ? `<strong>${task.time}</strong> ` : ''}${task.label}
              ${scheduleInfo}
            </div>
            <button class="manage-delete-btn" data-cat="${categoryId}" data-id="${task.id}" title="Delete">
              <i class="fas fa-trash-alt"></i>
            </button>
          `;

          itemEl.querySelector('.manage-delete-btn').addEventListener('click', async () => {
            if (confirm(`Delete task "${task.label}"?`)) {
              try {
                await checklistManager.removeTask(categoryId, task.id);
                renderManageList();
                renderWidget();
              } catch (err) {
                alert('Failed to delete: ' + err.message);
              }
            }
          });

          manageList.appendChild(itemEl);
        });
      });
    }

    // Add new task
    document.getElementById('add-task-btn').addEventListener('click', async () => {
      const categoryId = document.getElementById('new-task-category').value;
      const label = document.getElementById('new-task-label').value.trim();
      const time = document.getElementById('new-task-time').value.trim();

      // Schedule Parsing
      const freq = freqSelect.value;
      let schedule = { type: freq };

      if (freq === 'weekly') {
        const date = freqDate.value;
        if (!date) {
          alert('Please pick a date to set the repeating day');
          return;
        }
        // Derive day of week (0-6)
        // Note: new Date(dateStr) parses as UTC if YYYY-MM-DD
        // causing off-by-one errors if not careful.
        // Better: use new Date(Y, M, D)
        const parts = date.split('-');
        const d = new Date(parts[0], parts[1] - 1, parts[2]);
        schedule.days = [d.getDay()];
      } else if (freq === 'once') {
        const date = freqDate.value;
        if (!date) {
          alert('Please select a date');
          return;
        }
        schedule.date = date;
      }

      if (!label) {
        alert('Please enter a task name');
        return;
      }

      try {
        const btn = document.getElementById('add-task-btn');
        const originalText = btn.textContent;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';

        await checklistManager.addTask(categoryId, { label, time, schedule });

        // Reset form
        document.getElementById('new-task-label').value = '';
        document.getElementById('new-task-time').value = '';
        freqSelect.value = 'daily';
        freqDateContainer.style.display = 'none';
        freqHint.textContent = '';
        btn.textContent = originalText;

        renderManageList();
        renderWidget();
      } catch (err) {
        document.getElementById('add-task-btn').textContent = 'Add Task';
        alert('Failed to add task: ' + err.message);
      }
    });

    // --- History UI Logic ---
    const historyModal = document.getElementById('history-modal');
    const historyList = document.getElementById('history-list');
    const historyBtn = document.getElementById('widget-history');

    historyBtn.addEventListener('click', () => {
      renderHistoryList();
      historyModal.style.display = 'flex';
    });

    document.querySelector('.close-history').addEventListener('click', () => {
      historyModal.style.display = 'none';
    });

    historyModal.addEventListener('click', (e) => {
      if (e.target === historyModal) historyModal.style.display = 'none';
    });

    function renderHistoryList() {
      const history = checklistManager.getHistory();
      historyList.innerHTML = '';

      if (!history || history.length === 0) {
        historyList.innerHTML = '<div style="padding: 1rem; text-align: center; color: #666;">No history available yet. History is created when a new day starts.</div>';
        return;
      }

      history.forEach(day => {
        const date = new Date(day.date).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
        const completion = day.stats ? `${day.stats.completed}/${day.stats.total}` : 'N/A';
        const percentage = day.stats && day.stats.total > 0 ? Math.round((day.stats.completed / day.stats.total) * 100) : 0;

        const row = document.createElement('div');
        row.className = 'history-item'; // Add style for this
        row.style.cssText = 'padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;';
        row.innerHTML = `
                <div>
                    <strong>${date}</strong>
                    <div style="font-size: 0.85rem; color: #666;">${completion} completed</div>
                </div>
                <div style="font-weight: bold; color: ${percentage === 100 ? 'green' : '#666'};">${percentage}%</div>
            `;

        // Expand details
        row.addEventListener('click', () => {
          // Show details (could use a nested list or replace content)
          // For MVP: Simple toggle details
          const details = row.nextElementSibling;
          if (details && details.classList.contains('history-details')) {
            details.remove();
          } else {
            const detailRow = document.createElement('div');
            detailRow.className = 'history-details';
            detailRow.style.cssText = 'background: #f9f9f9; padding: 1rem; border-bottom: 1px solid #eee;';

            let content = '';
            const items = day.items || {};
            // Since we don't snapshot full task details, we might only have IDs in 'items'.
            // But wait, performDailyReset saved 'items' which is { id: { checked, checkedBy... } }
            // It does NOT save the labels. 
            // CRITICAL FIX: ChecklistManager.performDailyReset relies on generic IDs. 
            // Retrospective fix: We need to snapshot labels in history or lookup definitions.
            // But definitions might change. 
            // Current best effort: Lookup current definitions. If deleted, show ID.

            const allDefs = checklistManager.getAllDefinitions();
            const flatDefs = {};
            Object.values(allDefs).forEach(cat => cat.forEach(t => flatDefs[t.id] = t));

            Object.entries(items).forEach(([id, state]) => {
              if (state.checked) {
                const label = flatDefs[id]?.label || 'Unknown Task';
                content += `<div style="margin-bottom: 4px;">‚úì ${label} <span style="color:#666; font-size:0.8em">(${state.checkedBy})</span></div>`;
              }
            });

            if (!content) content = '<div>No completed tasks</div>';

            detailRow.innerHTML = content;
            row.parentNode.insertBefore(detailRow, row.nextSibling);
          }
        });

        historyList.appendChild(row);
      });
    }

    async function initWidget() {
      // Update greeting regardless of config
      updateHeroGreeting();

      if (!checklistManager.isConfigured()) {
        widgetLoading.style.display = 'none';
        // Show setup prompt
        widgetError.innerHTML = `
          <div style="text-align: left;">
            <strong>One-time setup required</strong><br>
            <small style="display: block; margin: 0.5rem 0;">Enter a GitHub token with "gist" permission:</small>
            <input type="password" id="token-input" placeholder="ghp_..." style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 0.5rem;">
            <button id="token-submit" style="background: var(--primary-color); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Save Token</button>
            <a href="https://github.com/settings/tokens/new?scopes=gist&description=Morrisons%20Checklist" target="_blank" style="margin-left: 0.5rem; font-size: 0.8rem;">Get token</a>
          </div>
        `;
        widgetError.style.display = 'block';
        widgetError.style.background = '#fff3cd';
        widgetError.style.color = '#856404';
        widgetError.style.border = '1px solid #ffc107';

        document.getElementById('token-submit').addEventListener('click', async () => {
          const token = document.getElementById('token-input').value.trim();
          if (token) {
            setToken(token);
            widgetError.style.display = 'none';
            widgetLoading.style.display = 'flex';
            await initWidget();
          }
        });
        return;
      }

      try {
        await checklistManager.sync();
        widgetLoading.style.display = 'none';
        widgetContent.style.display = 'block';
        renderWidget();

        checklistManager.subscribe(() => renderWidget());
        checklistManager.startAutoSync(30000);

        // Start notification checker
        setInterval(checkDueTasks, 60000); // Check every minute
        setTimeout(checkDueTasks, 2000);   // Initial check
      } catch (error) {
        console.error('Widget init failed:', error);
        widgetLoading.style.display = 'none';
        widgetError.textContent = 'Failed to load checklist: ' + error.message;
        widgetError.style.display = 'block';
      }
    }

    // --- Notification Logic ---
    const notifiedTasks = new Set(); // Track tasks we've already alerted for

    function parseTime(timeStr) {
      if (!timeStr) return null;
      // Handle "9:00", "09:00", "5:00pm", "17:00"
      try {
        const d = new Date();
        let [time, modifier] = timeStr.split(/(am|pm)/i);
        let [hours, minutes] = time.split(':');

        if (!hours || !minutes) return null; // "Daily", "Weekly" etc

        hours = parseInt(hours);
        minutes = parseInt(minutes);

        if (modifier) {
          modifier = modifier.toLowerCase();
          if (modifier === 'pm' && hours < 12) hours += 12;
          if (modifier === 'am' && hours === 12) hours = 0;
        }

        d.setHours(hours, minutes, 0, 0);
        return d;
      } catch (e) {
        return null;
      }
    }

    // Request notification permission on page load
    async function requestNotificationPermission() {
      if (!('Notification' in window)) {
        console.log('This browser does not support notifications');
        return false;
      }
      if (Notification.permission === 'granted') {
        return true;
      }
      if (Notification.permission !== 'denied') {
        const permission = await Notification.requestPermission();
        return permission === 'granted';
      }
      return false;
    }

    // Send a native device notification
    function sendDeviceNotification(title, body, icon = '/favicon.ico') {
      if (Notification.permission === 'granted') {
        const notification = new Notification(title, {
          body: body,
          icon: icon,
          badge: icon,
          tag: body, // Prevents duplicate notifications
          requireInteraction: true // Keeps notification until user dismisses
        });

        // Focus the tab when notification is clicked
        notification.onclick = () => {
          window.focus();
          notification.close();
        };

        return true;
      }
      return false;
    }

    function checkDueTasks() {
      const username = getUsername();
      if (!username || username === 'Team') return;

      const now = new Date();
      const items = checklistManager.getItems();

      Object.values(items).forEach(category => {
        category.items.forEach(task => {
          const state = checklistManager.getItemState(task.id);

          // Only check assignments for current user that are incomplete
          if (state.assignedTo === username && !state.checked) {
            const dueTime = parseTime(task.time);
            if (!dueTime) return;

            const diffMs = dueTime - now;
            const diffMins = Math.floor(diffMs / 60000);

            // Logic: 
            // 1. Due soon (0-10 mins)
            // 2. Overdue (< 0 mins)

            if (diffMins <= 10 && diffMins > 0) {
              if (!notifiedTasks.has(`${task.id}-soon`)) {
                const sent = sendDeviceNotification(
                  '‚ö†Ô∏è Task Due Soon',
                  `"${task.label}" is due in ${diffMins} mins!`
                );
                if (!sent && window.notify) {
                  window.notify(`‚ö†Ô∏è Task "${task.label}" is due in ${diffMins} mins!`, 5000);
                }
                notifiedTasks.add(`${task.id}-soon`);
              }
            } else if (diffMins <= 0) {
              if (!notifiedTasks.has(`${task.id}-overdue`)) {
                const sent = sendDeviceNotification(
                  'üö® Task OVERDUE',
                  `"${task.label}" is overdue!`
                );
                if (!sent && window.notify) {
                  window.notify(`üö® Task "${task.label}" is OVERDUE!`, 6000);
                }
                notifiedTasks.add(`${task.id}-overdue`);
              }
            }
          }
        });
      });
    }

    // Request permission when page loads
    requestNotificationPermission();

    widgetSync.addEventListener('click', async () => {
      widgetSync.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      try {
        await checklistManager.sync();
      } catch (err) {
        console.error(err);
      }
      widgetSync.innerHTML = '<i class="fas fa-sync-alt"></i>';
    });

    initWidget();
  </script>

  <!-- Failsafe: Standalone Reset Handler (Works even if app crashes) -->
  <script>
    document.getElementById('widget-reset-token').addEventListener('click', () => {
      if (confirm('Reset authentication token? You will need to re-enter it.')) {
        localStorage.removeItem('checklist_github_token');
        location.reload();
      }
    });
  </script>

  initWidget();
  </script>
</body>

</html>